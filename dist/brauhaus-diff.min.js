/*
@preserve
Brauhaus.js Diff Plugin
Copyright 2013 Jens Taylor <jensyt@gmail.com>
https://github.com/homebrewing/brauhaus-diff
*/
!function(){var t,e,n,i,r,o,l,a,s,f,u,c,h,y,p,g,b,j,v,d,m=[].slice,A={}.hasOwnProperty;t=null!=(v=this.Brauhaus)?v:require("brauhaus"),p=null!=(d=this.MurmurHash3)?d:require("imurmurhash"),r="undefined"!=typeof exports&&null!==exports?exports:{},t.Diff=r,s={exportUtil:!1,usingBrauhausStyles:null!=t.STYLES&&"function"==typeof t.getStyles,removeDefaultValues:!1,enablePostDiff:!0,enablePostApply:!0},r.configure=function(t){return"object"!=typeof t?r:(null!=t.exportUtil&&(s.exportUtil=!!t.exportUtil),null!=t.usingBrauhausStyles&&(s.usingBrauhausStyles=!!t.usingBrauhausStyles),null!=t.removeDefaultValues&&(s.removeDefaultValues=!!t.removeDefaultValues),null!=t.enablePostDiff&&(s.enablePostDiff=!!t.enablePostDiff),null!=t.enablePostApply&&(s.enablePostApply=!!t.enablePostApply),s.exportUtil&&null==r.util&&(r.util=h),r)},t.Fermentable.prototype._diffKeys=["name","late",["weight","color","yield"]],t.Spice.prototype._diffKeys=["name",["use","form"],["time","weight","aa"]],t.Yeast.prototype._diffKeys=["name",["type","form"],"attenuation"],t.MashStep.prototype._diffKeys=[["name","type"],["waterRatio","temp","endTemp","time","rampTime"]],h={getKeys:function(t,e){var n,i,r,o,l;r=[],n=[];for(i in t)l=t[i],h.keyPass(i,l)&&(i in e&&h.keyPass(i,e[i])?n.push(i):r.push(i));o=[];for(i in e)l=e[i],h.keyPass(i,l)&&(i in t&&h.keyPass(i,t[i])||o.push(i));return[r,o,n]},keyPass:function(t,e){return"function"==typeof e||"_"===t.charAt(0)?!1:!0},isEmpty:function(t){var e,n;if(t instanceof Array)return 0===t.length;for(e in t)if(n=t[e],h.keyPass(e,n))return!1;return!0},areAll:function(){var t,e,n,i,r;for(n=arguments[0],e=2<=arguments.length?m.call(arguments,1):[],i=0,r=e.length;r>i;i++)if(t=e[i],!(t instanceof n))return!1;return e.length>0?!0:!1},areAny:function(t,e){var n,i,r;for(i=0,r=e.length;r>i;i++)if(n=e[i],n instanceof t)return!0;return!1},compatibleTypes:function(t,e){var n,i,r,o;return t instanceof Array!=e instanceof Array?!1:t instanceof e.constructor||e instanceof t.constructor?!0:(o=h.getKeys(t,e),i=o[0],r=o[1],n=o[2],n.length>.75*(i.length+r.length+n.length))},hash:function(t){var e;return null!=t._diffKeys?(e=p(),h.hashObjKeys(e,t,t._diffKeys)):e=p(JSON.stringify(t)),e.result().toString(32)},hashObjKeys:function(t,e,n){var i,r,o;for(r=0,o=n.length;o>r;r++)i=n[r],i instanceof Array?h.hashObjKeys(t,e,i):(t.hash(i),t.hash(":"),t.hash(e[i].toString()),t.hash("|"))},diffCopy:function(t,e){var n,i,r;if(n="function"==typeof t.toJSON?t.toJSON():h.shallowCopy(t,!0),n instanceof Object){for(i in n)r=n[i],h.keyPass(i,r)||delete n[i];if(e.removeDefaultValues===!0)for(i in t)t.hasOwnProperty(i)||delete n[i]}return n},shallowCopy:function(t,e){var n,i,r;if(t instanceof Array)n=t.slice();else if(t instanceof Object&&!(t instanceof Function))if(e){n={};for(i in t)r=t[i],n[i]=r}else{n=Object.create(Object.getPrototypeOf(t));for(i in t)A.call(t,i)&&(r=t[i],n[i]=r)}return null!=n?n:t},checkKeyVal:function(t,e,n,i){return h.areAll(Array,t,n)?h.arrayCompare(t,n)&&h.arrayCompare(e,i):t===n&&e===i},getKeyVal:function(t,e){var n,i;return null!=t._diffKeyVal&&null!=t._diffKeyVal[e]?t._diffKeyVal[e]:(null!=t._diffKeys&&null!=t._diffKeys[e]?(n=t._diffKeys[e],i=h.getValForKey(t,n)):n="_nokey",null==t._diffKeyVal&&(t._diffKeyVal=[]),t._diffKeyVal[e]=[n,i])},getValForKey:function(t,e){var n,i,r,o,l;if(e instanceof Array){for(l=[],r=0,o=e.length;o>r;r++)n=e[r],l.push(i=h.getValForKey(t,n));return l}return t[e]},arrayCompare:function(t,e){var n,i,r;if(t===e)return!0;if(t.length!==e.length)return!1;for(n=i=0,r=t.length;r>=0?r>i:i>r;n=r>=0?++i:--i)if(h.areAll(Array,t[n],e[n])){if(!h.arrayCompare(t[n],e[n]))return!1}else if(t[n]!==e[n])return!1;return!0},getKeyValScore:function(t,e,n,i){var r,o,l,a;if(o=0,h.areAll(Array,t,n))for(r=l=0,a=t.length;a>=0?a>l:l>a;r=a>=0?++l:--l)o+=h.getKeyValScore(t[r],e[r],n[r],i[r]);else t===n&&(o=e===i?2:1);return o},getMatchScore:function(t,e,n){var i,r,o,l,a,s,f,u,c;for(f=[];;){if(u=h.getKeyVal(t,n),i=u[0],r=u[1],c=h.getKeyVal(e,n),l=c[0],a=c[1],o="_nokey"!==i,s="_nokey"!==l,o&&s)f.push(h.getKeyValScore(i,r,l,a));else{if(!o&&!s)break;f.push(0)}++n}return 0===f.length&&f.push(0),f},getOne:function(t){return t instanceof e?t.obj instanceof Array?h.getOne(t.obj[0]):t.obj:t},Directions:{LeftToRight:1,RightToLeft:2},getDirection:function(t){var e;return t?"number"==typeof t?t:(e=t.charAt(0).toLowerCase(),"f"!==e&&"r"!==e?h.Directions.LeftToRight:h.Directions.RightToLeft):h.Directions.LeftToRight},simpleCompare:function(t,e){return h.areAll(Object,t,e)?!0:null==t&&null==e?!0:t===e}},o=function(){function t(e){return e instanceof t?e:this instanceof t?(this.fail=null!=e?e:!0,this.state=[],this.canFail="function"==typeof this.fail||!!this.fail,void 0):new t(e)}return t.prototype.push=function(t){return this.canFail?this.state.push(t):void 0},t.prototype.pop=function(){return this.canFail?this.state.pop():void 0},t.prototype.check=function(t,e){var n,i,r;if(this.canFail&&!h.simpleCompare(t,e)&&(i="function"==typeof this.fail,i&&this.fail(this.state,t,e)||!i&&this.fail))throw r=this.state.length?this.state.join("."):"none",n=new Error("Diff encountered an inconsistency "+("(key: "+r+", expected: "+t+", actual: "+e+")")),n.keys=this.state,n.expected=t,n.actual=e,n},t}(),i=function(){function t(e){var n,i;if(e instanceof t)return e;if(!(this instanceof t))return new t(e);if(null!=e)for(n in e)A.call(e,n)&&(i=e[n],this[n]=i)}return t}(),i.prototype=s,h.FailState=o,h.ConvertToOptions=i,e=function(){function t(t,e,n,i){this.key=t,this.val=e,this.obj=n,this.level=i}return t.Type={Unique:1,List:2,Category:3},t.prototype.add=function(t){return this.obj instanceof Array||(this.obj=[this.obj]),this.obj.push(t),this},t.prototype.remove=function(e){var n,i,r,o,l,a,s,f,u,c;if(i=!1,a=this.getType(),a===t.Type.Category)for(u=h.getKeyVal(e,this.level+1),o=u[0],l=u[1],c=this.obj,r=s=0,f=c.length;f>s&&(n=c[r],!h.checkKeyVal(o,l,n.key,n.val)||(i=n.remove(e,this.level+1),null===n.obj&&this.cleanUp(r,1),!i));r=++s);else a===t.Type.List?(r=this.obj.indexOf(e),r>=0&&(this.cleanUp(r,1),i=!0)):this.obj===e&&(this.obj=null,i=!0);return i},t.prototype.cleanUp=function(e,n){if(this.obj instanceof Array){if(this.obj.length===n)return this.obj=null;if(n>0&&this.obj.splice(e,n),1===this.obj.length&&!(this.obj[0]instanceof t))return this.obj=this.obj[0]}else if(n>0)return this.obj=null},t.prototype.getType=function(){return this.obj instanceof Array?this.obj.length>0&&this.obj[0]instanceof t?t.Type.Category:t.Type.List:t.Type.Unique},t.categorize=function(e){return t.processLevel(new t("_root",null,e,-1))},t.processLevel=function(e){var n,i,r,o,l,a,s,f,u,c,y,p,g,b;if(!(e.obj instanceof Array))return e;for(i=function(t,e){var i,r,o;for(r=0,o=n.length;o>r;r++)if(i=n[r],h.checkKeyVal(i.key,i.val,t,e))return i},o=e.level+1,n=[],g=e.obj,u=0,y=g.length;y>u;u++)a=g[u],b=h.getKeyVal(a,o),r=b[0],f=b[1],l=i(r,f),null!=l?l.add(a):n.push(new t(r,f,a,o));if(1!==n.length||"_nokey"!==n[0].key){for(c=0,p=n.length;p>c;c++)s=n[c],t.processLevel(s,o);e.obj=n}return e},t}(),n=function(){function t(n){this.cat=n,this.i=0,n.getType()===e.Type.Category&&(this.subit=new t(n.obj[0]))}return t.prototype.next=function(){var e;if(e=null,this.cat.obj instanceof Array)if(null!=this.subit)for(e=this.subit.next();null==e&&!(++this.i>=this.cat.obj.length);)this.subit=new t(this.cat.obj[this.i]),e=this.subit.next();else this.i<this.cat.obj.length&&(e=this.cat.obj[this.i]),++this.i;else 0===this.i++&&(e=this.cat.obj);return e},t.prototype.remove=function(){var e,n;return e=!1,this.cat.obj instanceof Array?null!=this.subit?(e=this.subit.remove(),null==this.subit.cat.obj&&(this.cat.cleanUp(this.cat.obj.indexOf(this.subit.cat),1),this.subit=null!=this.cat.obj&&this.i<this.cat.obj.length?new t(this.cat.obj[this.i]):null)):0<(n=this.i)&&n<=this.cat.obj.length&&(this.cat.cleanUp(--this.i,1),e=!0):null!=this.cat.obj&&(this.cat.cleanUp(0,1),e=!0),e},t}(),h.Category=e,h.CategoryIterator=n,r.diff=function(t,e,n){var i,r;return h.areAll(Array,t,e)?(r=function(t){var e,n,i;for(n=0,i=t.length;i>n;n++)if(e=t[n],!(e instanceof Object)||e instanceof Array)return!1;return!0},i=r(t)&&r(e)?new l(t,e,n):new a(t,e,n)):i=h.areAll(Object,t,e)&&h.compatibleTypes(t,e)?new a(t,e,n):t!==e?new f(t,e,n):{},i},j=function(t,e,n,i){var r,o;i.enablePostDiff&&("function"==typeof(null!=t?t.postDiff:void 0)?r=t.postDiff:"function"==typeof(null!=t?t.constructor.postDiff:void 0)&&(r=t.constructor.postDiff),"function"==typeof(null!=e?e.postDiff:void 0)?o=e.postDiff:"function"==typeof(null!=e?e.constructor.postDiff:void 0)&&(o=e.constructor.postDiff),null!=r&&r(t,e,n,i),null!=o&&o!==r&&o(t,e,n,i))},r.apply=function(t,e,n,o){var l,a,s,f,u,c,h;if("string"==typeof e)e=r.parse(e);else if(e instanceof Array)for(a=f=0,c=e.length;c>f;a=++f)l=e[a],"string"==typeof l&&(e[a]=r.parse(l));if(s="string"==typeof n?i({direction:n,fail:o}):i(n),e instanceof Array)for(u=0,h=e.length;h>u;u++)l=e[u],t=l.apply(t,s);else t=e.apply(t,s);return t},b=function(t,e,n){return n.enablePostApply&&("function"==typeof(null!=t?t.postApply:void 0)?t.postApply(t,e,n):"function"==typeof(null!=t?t.constructor.postApply:void 0)&&t.constructor.postApply(t,e,n)),t},r.combine=function(){throw new Error("not implemented yet")},r.parse=function(t){var e;return"string"==typeof t&&(e=JSON.parse(t)),c(null!=e?e:t)},c=function(t){var e;if(t instanceof Array){if(t.length>0&&null!=(null!=(e=t[0])?e._h:void 0))return l.fromObject(t);if(2===t.length)return f.fromObject(t);throw new TypeError("Trying to inflate non-diff object: "+JSON.stringify(t))}if(t instanceof Object)return a.fromObject(t);throw new TypeError("Trying to inflate non-diff object: "+JSON.stringify(t))},f=function(){function t(t,e,n){n=i(n),this.left=!(t instanceof Array)&&t instanceof Object?h.diffCopy(t,n):t,this.right=!(e instanceof Array)&&e instanceof Object?h.diffCopy(e,n):e,j(t,e,this,n)}return t.prototype.toJSON=function(){return[this.left,this.right]},t.prototype.apply=function(t,e,n){var r;return e=i(e),r=e.fail=o(e.fail),e.direction=h.getDirection(e.direction),e.direction===h.Directions.LeftToRight?(r.check(this.left,t),t=null!=n?new n(this.right):this.right):(r.check(this.right,t),t=null!=n?new n(this.left):this.left),b(t,this,e)},t.fromObject=function(e){return new t(e[0],e[1])},t}(),a=function(){function t(t,e,n){var o,l,a,s,u,c,y,p,g,b,v,d,m,A,w,V;if(null!=t||null!=e){for(n=i(n),s="function"==typeof t.toJSON?t.toJSON():t,c="function"==typeof e.toJSON?e.toJSON():e,A=h.getKeys(s,c),a=A[0],u=A[1],o=A[2],p=0,v=a.length;v>p;p++)l=a[p],this[l]=new f(s[l],null,n);for(g=0,d=u.length;d>g;g++)l=u[g],this[l]=new f(null,c[l],n);for(b=0,m=o.length;m>b;b++)l=o[b],y=r.diff(null!=(w=s[l])?w:null,null!=(V=c[l])?V:null,n),h.isEmpty(y)||(this[l]=y);j(t,e,this,n)}}return t.prototype.apply=function(t,e,n){var r,a,s,f,u;if(!(t instanceof Object))throw new Error("Object diff being applied to non-object");t=h.shallowCopy(t),e=i(e),r=e.fail=o(e.fail);for(a in this)f=this[a],h.keyPass(a,f)&&(s=null!=(u=t._paramMap)?u[a]:void 0,r.push(a),f instanceof l&&!(t[a]instanceof Array)?r.check("array",typeof t[a]):t[a]=f.apply(t[a],e,s),r.pop());return null!=n&&(t=new n(t)),b(t,this,e)},t.fromObject=function(e){var n,i,r;n=new t;for(i in e)r=e[i],n[i]=c(r);return n},t}(),l=function(){function t(t,o,l){var a,s,u,c,y,p,b,v,d,m,A,w,V;if(null!=t||null!=o){if(l=i(l),c=e.categorize(t),v=e.categorize(o),b=g.getPairs(c,v),null!=c.obj)for(u=new n(c);null!=(y=u.next());)b.push([y,null]);if(null!=v.obj)for(u=new n(v);null!=(d=u.next());)b.push([null,d]);for(this.diff=[],A=0,w=b.length;w>A;A++)p=b[A],null!=p[0]&&null!=p[1]?(delete p[0]._diffKeyVal,delete p[1]._diffKeyVal,a=r.diff(p[0],p[1]),h.isEmpty(a)||(a._h=new f(h.hash(p[0]),h.hash(p[1]),l))):(m=null!=(V=p[0])?V:p[1],delete m._diffKeyVal,a=h.diffCopy(m,l),s=h.hash(m),a._h=null!=p[0]?new f(s,null,l):new f(null,s,l)),h.isEmpty(a)||this.diff.push(a);0===this.diff.length&&delete this.diff,j(t,o,this,l)}}return t.prototype.toJSON=function(){var t;return null!=(t=this.diff)?t:[]},t.getPairs=function(t,n){var i,r;return i=t.getType(),r=n.getType(),i===e.Type.Unique?r===e.Type.Unique?g.uniqueVsUnique(t,n):g.uniqueVsArray(t,n,!1):r===e.Type.Unique?g.uniqueVsArray(n,t,!0):i===e.Type.Category?r===e.Type.Category?g.catVsCat(t,n):g.listVsCategory(n,t,!0):r===e.Type.Category?g.listVsCategory(t,n,!1):g.listVsList(t,n)},t.uniqueVsUnique=function(t,e){var n;return n=[[t.obj,e.obj]],t.cleanUp(0,1),e.cleanUp(0,1),n},t.uniqueVsArray=function(t,e,n){var i,r;return i=g.takeBestMatch(t.obj,e),null!=i?(r=n?[[i,t.obj]]:[[t.obj,i]],t.cleanUp(0,1),r):[]},t.listVsCategory=function(t,e,n){var i,r,o,l,a,s,f;for(l=[],i=0,f=t.obj,a=0,s=f.length;s>a&&(r=f[a],o=g.takeBestMatch(r,e),null!=o)&&(l.push(n?[o,r]:[r,o]),++i,null!=e.obj);a++);return t.cleanUp(0,i),l},t.listVsList=function(t,e){var n,i,r,o;for(r=[],i=Math.min(t.obj.length,e.obj.length),n=o=0;i>=0?i>o:o>i;n=i>=0?++o:--o)r.push([t.obj[n],e.obj[n]]);return t.cleanUp(0,i),e.cleanUp(0,i),r},t.catVsCat=function(t,e,n){var i,r,o,l,a,s,f,u,c,y,p,b;for(null==n&&(n=t.level>=0),i=0,l=[],y=t.obj,s=0,u=y.length;u>s;s++){for(b=y[s],o=t.obj[i],p=e.obj,r=f=0,c=p.length;c>f;r=++f)if(a=p[r],h.checkKeyVal(o.key,o.val,a.key,a.val)){l=l.concat(g.getPairs(o,a)),null===a.obj&&e.obj.splice(r,1);break}if(null===o.obj?t.obj.splice(i,1):++i,0===e.obj.length)break}return t.cleanUp(0,0),e.cleanUp(0,0),n&&null!=t.obj&&null!=e.obj&&(l=l.concat(g.catVsCatSecondPass(t,e))),l},t.catVsCatSecondPass=function(t,e){var i,r,o,l,a,s;for(i=function(n,r,o){var l;return l=g.bestMatch(r,o?t.obj:e.obj,t.level+1),n===l?o?[n,r]:[r,n]:i(r,l,!o)},s=[];;){if(null==e.obj||null==t.obj)break;if(r=new n(t),l=r.next(),null==l)break;if(!(e.obj instanceof Array)){s.push([l,e.obj]),r.remove(),e.cleanUp(0,1);break}if(o=g.bestMatch(l,e.obj,t.level+1),null==o)break;a=i(l,o,!0),a[0]===l?r.remove():t.remove(a[0]),e.remove(a[1]),s.push(a)}return s},t.bestMatch=function(t,n,i){var r,o,l,a,s,f,u,c,y,p,b,j;for(s=[],a=0,b=h.getKeyVal(t,i),f=b[0],u=b[1],c=function(t,e,n){var i;return i=h.getKeyValScore(f,u,t,e),i>a?(s=n instanceof Array?[].concat(n):[n],a=i):i===a?n instanceof Array?s=s.concat(n):s.push(n):void 0},y=0,p=n.length;p>y;y++)r=n[y],r instanceof e?c(r.key,r.val,r.obj):(j=h.getKeyVal(r,i),o=j[0],l=j[1],c(o,l,r));if("_nokey"===f){if(s.length>0)return h.getOne(s[0])}else if(s.length>0)return 1!==s.length||s[0]instanceof e?g.bestMatch(t,s,i+1):s[0]},t.takeBestMatch=function(t,e){var n,i;return n=e.obj instanceof Array?e.obj:[e.obj],i=g.bestMatch(t,n,e.level+1),null!=i&&e.remove(i),i},t.fromObject=function(e){var n,i,r,o;for(n=new t,n.diff=[],r=0,o=e.length;o>r;r++)i=e[r],null!=i._h[0]&&null!=i._h[1]?n.diff.push(c(i)):(i._h=c(i._h),n.diff.push(i));return n},t.prototype.apply=function(t,e,n){var r,l,a,s,f,u,c,y,p,j;if(!(t instanceof Array))throw new Error("Array diff being applied to non-array");for(t=h.shallowCopy(t),e=i(e),l=e.fail=o(e.fail),r=h.getDirection(e.direction)===h.Directions.LeftToRight,a=function(){var e,n,i;for(i=[],e=0,n=t.length;n>e;e++)c=t[e],i.push(h.hash(c));return i}(),j=this.diff,y=0,p=j.length;p>y;y++)c=j[y],f=g.determineType(c,r),s=a.indexOf(r?1===f?c._h.right:c._h.left:1===f?c._h.left:c._h.right),s>=0?0===f?(l.push(s),t[s]=c.apply(t[s],e),l.pop()):2===f?(a.splice(s,1),t.splice(s,1)):(l.push(s),l.check(null,a[s]),l.pop(),u=h.diffCopy(c,e),t.push(null!=n?new n(u):u)):1===f?(u=h.diffCopy(c,e),t.push(null!=n?new n(u):u)):(l.push(-1),l.check(r?c._h.left:c._h.right,null),l.pop());return b(t,this,e)},t.determineType=function(t,e){if(null!=t._h.left)return null!=t._h.right?0:e?2:1;if(null!=t._h.right)return e?1:2;throw new Error("Array diff missing object hashes")},t}(),g=l,h.ValueDiff=f,h.ObjectDiff=a,h.ObjectArrayDiff=l,t.Recipe.postDiff=function(t,e,n,i){var r,o,l,a,s,c,h,p,g,b,j,v,d,m;if(i.usingBrauhausStyles&&null!=n.style)if(n.style instanceof f){if(null!=(null!=(h=n.style.left)?h.name:void 0)&&null!=n.style.left.category&&null!=y(n.style.left.category,n.style.left.name)&&u(n.style.left),null!=(null!=(p=n.style.right)?p.name:void 0)&&null!=n.style.right.category&&null!=y(n.style.right.category,n.style.right.name))return u(n.style.right)}else if(o=null!=(g=null!=(b=n.style.name)?b.left:void 0)?g:t.style.name,r=null!=(j=null!=(v=n.style.category)?v.left:void 0)?j:t.style.category,a=null!=(d=null!=(m=n.style.name)?m.right:void 0)?d:e.style.name,l=null!=(s=null!=(c=n.style.category)?c.right:void 0)?s:e.style.category,null!=y(r,o)&&null!=y(l,a))return u(n.style)},t.Recipe.postApply=function(t,e,n){var i,r,o;return n.usingBrauhausStyles&&(i=y(null!=(r=t.style)?r.category:void 0,null!=(o=t.style)?o.name:void 0),null!=i)?t.style=i:void 0},y=function(e,n){var i;try{return t.getStyle(e,n)}catch(r){i=r}},u=function(t){var e;for(e in t)A.call(t,e)&&"name"!==e&&"category"!==e&&delete t[e]}}.call(this);